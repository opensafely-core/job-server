{% extends "staff/base-tw.html" %}

{% load humanize %}
{% load querystring_tools %}
{% load selected_filter %}

{% block metatitle %}Job Requests: Staff Area | OpenSAFELY Jobs{% endblock metatitle %}

{% block breadcrumbs %}
{% #breadcrumbs %}
  {% url "home" as home_url %}
  {% url "staff:index" as staff_url %}
  {% breadcrumb title="Home" url=home_url %}
  {% breadcrumb title="Staff area" url=staff_url %}
  {% breadcrumb title="Job requests" active=True %}
{% /breadcrumbs %}
{% endblock breadcrumbs %}

{% block hero %}
<div class="bg-bn-ribbon-100 pt-6 pb-8">
  <div class="container">
    {% article_header title="Job requests" %}
  </div>
</div>
{% endblock hero %}

{% block content %}
{% url "staff:job-request-list" as staff_job_request_list_url %}

<div class="grid lg:grid-cols-3 gap-8">
  <div class="flex flex-col gap-y-6">
    {% if request.GET.orgs or request.GET.project or request.GET.user or request.GET.workspace %}
      {% #button variant="secondary-outline" type="link" href=staff_job_request_list_url %}
        Clear filters
      {% /button %}
    {% endif %}

    {% #card title="Filter by organisation" %}
      <filter-input aria-owns="orgsFilter">
        {% form_input custom_field=True class="px-4 -mt-2 mb-4 sm:px-6" id="filterOrgs" name="filter-orgs" label="Search for an organisation" label_class="sr-only" placeholder="Search for an organisation" show_placeholder=True %}
      </filter-input>
      {% #list_group small=True class="max-h-96 overflow-y-auto" data_filter_list=True id="orgsFilter" %}
        {% for org in orgs.items %}
          {% is_filter_selected key="orgs" value=org.slug as is_org_selected %}
          {% url_with_querystring orgs=org.slug as add_org_query_url %}

          {% if is_org_selected %}
            {% url_without_querystring orgs=org.slug as remove_org_query_url %}
            {% #list_group_item href=remove_org_query_url role="checkbox" aria-checked="true" class="bg-green-100 text-green-800" %}
              {{ org.name }}
            {% /list_group_item %}
          {% else %}
            {% #list_group_item href=add_org_query_url role="checkbox" aria-checked="false" %}
              {{ org.name }}
            {% /list_group_item %}
          {% endif %}
        {% endfor %}
        {% list_group_empty title="No organisation found" data-filter-empty-state hidden %}
      {% /list_group %}
    {% /card %}

    {% #card title="Filter by project" %}
      <filter-input aria-owns="projectsFilter">
        {% form_input custom_field=True class="px-4 -mt-2 mb-4 sm:px-6" id="filterProjects" name="filter-projects" label="Search for a project" label_class="sr-only" placeholder="Search for a project" show_placeholder=True %}
      </filter-input>
      {% #list_group small=True class="max-h-96 overflow-y-auto" data_filter_list=True id="projectsFilter" %}
        {% for project in projects.items %}
          {% is_filter_selected key="project" value=project.slug as is_project_selected %}
          {% url_with_querystring project=project.slug as add_project_query_url %}

          {% if is_project_selected %}
            {% url_without_querystring project=project.slug as remove_project_query_url %}
            {% #list_group_item href=remove_project_query_url role="checkbox" aria-checked="true" class="bg-green-100 text-green-800" %}
              {{ project.title }}
            {% /list_group_item %}
          {% else %}
            {% #list_group_item href=add_project_query_url role="checkbox" aria-checked="false" %}
              {{ project.title }}
            {% /list_group_item %}
          {% endif %}
        {% endfor %}
        {% list_group_empty title="No projects found" data-filter-empty-state hidden %}
      {% /list_group %}
    {% /card %}

    {% #card title="Filter by user" %}
      <filter-input aria-owns="usersFilter">
        {% form_input custom_field=True class="px-4 -mt-2 mb-4 sm:px-6" id="filterUsers" name="filter-users" label="Search for a user" label_class="sr-only" placeholder="Search for a user" show_placeholder=True %}
      </filter-input>
      {% #list_group small=True class="max-h-96 overflow-y-auto" data_filter_list=True id="usersFilter" %}
        {% for user in users.items %}
          {% is_filter_selected key="user" value=user.username as is_user_selected %}
          {% url_with_querystring user=user.username as add_user_query_url %}

          {% if is_user_selected %}
            {% url_without_querystring user=user.username as remove_user_query_url %}
            {% #list_group_item href=remove_user_query_url role="checkbox" aria-checked="true" class="bg-green-100 text-green-800" %}
              {{ user.name }}
            {% /list_group_item %}
          {% else %}
            {% #list_group_item href=add_user_query_url role="checkbox" aria-checked="false" %}
              {{ user.name }}
            {% /list_group_item %}
          {% endif %}
        {% endfor %}
        {% list_group_empty title="No users found" data-filter-empty-state hidden %}
      {% /list_group %}
    {% /card %}

    {% #card title="Filter by workspace" %}
      <filter-input aria-owns="workspacesFilter">
        {% form_input custom_field=True class="px-4 -mt-2 mb-4 sm:px-6" id="filterWorkspaces" name="filter-workspaces" label="Search for a workspace" label_class="sr-only" placeholder="Search for a workspace" show_placeholder=True %}
      </filter-input>
      {% #list_group small=True class="max-h-96 overflow-y-auto" data_filter_list=True id="workspacesFilter" %}
        {% for workspace in workspaces.items %}
          {% is_filter_selected key="workspace" value=workspace.name as is_workspace_selected %}
          {% url_with_querystring workspace=workspace.name as add_workspace_query_url %}

          {% if is_workspace_selected %}
            {% url_without_querystring workspace=workspace.name as remove_workspace_query_url %}
            {% #list_group_item href=remove_workspace_query_url role="checkbox" aria-checked="true" class="bg-green-100 text-green-800" %}
              {{ workspace.name }}
            {% /list_group_item %}
          {% else %}
            {% #list_group_item href=add_workspace_query_url role="checkbox" aria-checked="false" %}
              {{ workspace.name }}
            {% /list_group_item %}
          {% endif %}
        {% endfor %}
        {% list_group_empty title="No workspaces found" data-filter-empty-state hidden %}
      {% /list_group %}
    {% /card %}
  </div>

  <div class="flex flex-col gap-y-6 lg:col-span-2">
    {% #card container=True title="Search for a job request" %}
      <form method="GET" class="flex flex-row gap-x-2 items-center">
        {% if request.GET.q %}
          {% var value=request.GET.q|stringformat:"s" %}
        {% endif %}
        {% form_input custom_field=True type="search" id="jobRequestSearch" name="q" value=value label="Search for a job request" label_class="sr-only" class="w-full" input_class="!m-0" placeholder="Search by number, identifier, name of author, workspace, project, or org" show_placeholder=True %}
        {% #button type="submit" variant="primary" class="flex-shrink-0" %}Search{% /button %}
      </form>
      {% if request.GET.q %}
        <p class="mt-3">
          {% link href=staff_job_request_list_url text="Clear search" %}
        </p>
      {% endif %}
    {% /card %}

    {% #card %}
      {% if object_list %}
        {% #list_group small=True %}
          {% for job_request in object_list %}
            {% with id=job_request.pk|stringformat:"s" %}
              {% var title="Request: "|add:id %}
              {% #list_group_rich_item type="Analysis Request" title=title url=job_request.get_staff_url %}
                <dl class="text-sm -mt-2">
                  <div class="flex flex-row gap-1">
                    <dt class="font-semibold">Created by:</dt>
                    <dd>{{ job_request.created_by.name }}</dd>
                  </div>
                  <div class="flex flex-row gap-1">
                    <dt class="font-semibold">Created at:</dt>
                    <dd>{{ job_request.created_at|date:"d F Y" }}</dd>
                  </div>
                </dl>
              {% /list_group_rich_item %}
            {% endwith %}
          {% endfor %}
        {% /list_group %}
      {% else %}
        {% list_group_empty icon=True title="No requests found" description="Try a new search or clearing the filters" %}
      {% endif %}

      {% if page_obj.has_previous or page_obj.has_next %}
        {% #card_footer no_container=True %}
          <nav class="flex items-center justify-between" aria-label="Pagination">
            <div class="hidden sm:block">
              <p class="text-sm text-gray-700">
                Page
                <span class="font-medium">{{ page_obj.number }}</span>
                of
                <span class="font-medium">{{ page_obj.paginator.num_pages }}</span>
              </p>
            </div>

            <div class="flex flex-1 justify-between sm:justify-end">
              {% if page_obj.has_previous %}
                {% url_with_querystring page=page_obj.previous_page_number as previous_page_url %}
                {% #button type="link" href=previous_page_url variant="secondary-outline" %}Previous{% /button %}
              {% endif %}
              {% if page_obj.has_next %}
                {% url_with_querystring page=page_obj.next_page_number as next_page_url %}
                {% #button type="link" href=next_page_url variant="secondary-outline" %}Next{% /button %}
              {% endif %}
            </div>
          </nav>
        {% /card_footer %}
      {% endif %}
    {% /card %}
  </div>
</div>
{% endblock content %}
