{% extends "staff/base.html" %}

{% load humanize %}

{% block metatitle %}{{ user.username }}: Staff Area | OpenSAFELY Jobs{% endblock metatitle %}

{% block breadcrumbs %}
<nav class="breadcrumb-container breadcrumb--danger" aria-label="breadcrumb">
  <div class="container">
    <ol class="breadcrumb rounded-0 mb-0 px-0">
      <li class="breadcrumb-item">
        <a href="{% url 'staff:index' %}">Staff area</a>
      </li>
      <li class="breadcrumb-item">
        <a href="{% url 'staff:user-list' %}">Users</a>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ user.username }}
      </li>
    </ol>
  </div>
</nav>
{% endblock breadcrumbs %}

{% block jumbotron %}
<div class="jumbotron jumbotron-fluid jumbotron--danger pt-md-2">
  <div class="container">
    <h1 class="display-4">{{ user.name }}</h1>

    <ul class="list-unstyled lead">
      <li>
        <strong>Username:</strong> {{ user.username }}
      </li>

      <li>
        <strong>Email:</strong>
        {{ user.notifications_email }}
      </li>

      <li>
        <strong>Created at:</strong> {{ user.date_joined }}
      </li>
    </ul>
  </div>
</div>
{% endblock jumbotron %}

{% block staff_content %}
<div class="container">
  <div class="row">
    <div class="col col-lg-9 col-xl-8">

      {% if not orgs or not user.backends.exists %}
      <div class="alert alert-danger" role="alert">
        <p>
          A user <strong>requires</strong> access to certain resources to be
          able to use the Jobs site.  The following are missing for this user:
        </p>
        <ul>
          {% if not user.backends.exists %}
          <li><a href="#backends">Backends</a></li>
          {% endif %}
          {% if not orgs %}
          <li><a href="#orgs">Orgs</a></li>
          {% endif %}
        </ul>
      </div>
      {% endif %}

      {% if not projects %}
      <div class="alert alert-warning" role="alert">
        A user would ideally have access to one or more <a href="#projects">Projects</a>.
      </div>
      {% endif %}

      <form method="POST">
        {% csrf_token %}

        {% if form.non_field_errors %}
        <ul>
          {% for error in form.non_field_errors %}
          <li class="text-danger">{{ error }}</li>
          {% endfor %}
        </ul>
        {% endif %}

        {% include "components/form_text.html" with field=form.fullname label="Full name" name="fullname" %}

        <div class="form-group">
          <h2 id="backends" class="h4">Backends</h2>

          <p>
            A list of backends {{ user.username }} has access to.
          </p>

          <p>
            Once you've
            <a href="https://docs.google.com/spreadsheets/d/1rmFdaUz2BFedLL9cgVk-PDWINeLAeupR0TYoS8Btlh0/edit#gid=0&range=Q1">
              confirmed the user has signed a DAA and their application has been approved
            </a>,
            grant them access to only the backends their study requires.
          </p>

          <ul class="list-group mb-5">
            {% for value, label in form.backends.field.choices %}
            <li class="list-group-item">
              <div class="custom-control custom-checkbox">
                <input
                  type="checkbox"
                  class="custom-control-input"
                  id="id_backends_{{ forloop.counter0 }}"
                  name="backends"
                  value="{{ value }}"
                  {% if value in form.backends.value %}
                  checked
                  {% endif %}
                />
                <label class="custom-control-label" for="id_backends_{{ forloop.counter0 }}">
                  {{ label }}
                </label>
              </div>
            </li>
            {% endfor %}
          </ul>

          {% if form.backends.errors %}
          <ul class="pl-3 mb-1">
            {% for error in form.backends.errors %}
            <li class="text-danger">{{ error }}</li>
            {% endfor %}
          </ul>
          {% endif %}

        </div>

        <div class="form-group mb-5">
          <div class="d-flex justify-content-between align-items-center">
            <h2 id="orgs" class="h4">Organisations</h2>
            <a class="btn btn-sm btn-primary" href="{% url 'staff:user-set-orgs' username=user.username %}">
              Add to organisation
            </a>
          </div>

          <div class="list-group mb-3">
            {% for org in orgs %}
            <a class="list-group-item list-group-item-action d-flex" href="{{ org.staff_url }}">
              <span class="mr-auto">{{ org.name }}</span>
              {% for role in org.roles %}
              <span class="badge badge-secondary ml-1">{{ role }}</span>
              {% endfor %}
            </a>
            {% endfor %}
          </div>
        </div>

        <div class="form-group mb-5">
          <h2 id="projects" class="h4">Projects</h2>

          <div class="list-group mb-3">
            {% for project in projects %}
            <a class="list-group-item list-group-item-action d-flex align-items-center" href="{{ project.staff_url }}">
              <span class="mr-auto">{{ project.name }}</span>
              {% for role in project.roles %}
              <span class="badge badge-secondary ml-1">{{ role }}</span>
              {% endfor %}
            </a>
            {% endfor %}
          </div>
        </div>

        {% include "components/form_roles.html" with field=form.roles label="Global Roles" name="roles" %}

        <div class="form-group mb-3">
          <h2 class="h4">Authored Applications</h2>

          <div class="list-group mb-3">
            {% for application in applications %}
            <a class="list-group-item list-group-item-action" href="{{ application.get_staff_url }}">

              <div>
                Application {{ application.pk_hash }}
                {% if application.studyinformationpage.study_name %}
                ({{ application.studyinformationpage.study_name }})
                {% endif %}
              </div>

              <div>
                <small class="text-muted">Started on {{ application.created_at|date }}</small>
              </div>

              {% if application.completed_at %}
              <div>
                <small class="text-muted">Submitted on {{ application.completed_at|date }}</small>
              </div>
              {% endif %}

            </a>
            {% empty %}
            <p class="list-group-item">No applications.</p>
            {% endfor %}
          </div>
        </div>

        <div class="form-group mb-5">
          <h2 class="h4">Co-piloted Projects</h2>

          <div class="list-group mb-3">
            {% for project in copiloted_projects %}
            <a class="list-group-item list-group-item-action" href="{{ project.get_staff_url }}">
              {{ project.title }}
            </a>
            {% empty %}
            <p class="list-group-item">No co-piloted projects.</p>
            {% endfor %}
          </div>
        </div>

        <div class="form-group">
          <button class="btn btn-primary" type="submit">Save</button>
        </div>

      </form>

      <div id="jobs" class="mt-5">

        <div class="d-flex justify-content-between">
          <h2 class="h4">Jobs</h2>
          <div>
            <a class="btn btn-sm btn-primary" href="{% url 'job-list' %}?username={{ user.username }}">
              View all ({{ jobs|length }})
            </a>
          </div>
        </div>

        <table class="table">
          <thead>
            <tr>
              <th scope="col">Status</th>
              <th scope="col">Job</th>
              <th scope="col">Created</th>
              <th scope="col">Runtime</th>
            </tr>
          </thead>
          <tbody>
            {% for job in jobs %}
            <tr>
              <td>
                <div
                  class="status status-icon {{ job.status }}"
                  data-placement="bottom"
                  data-toggle="tooltip"
                  title="{{ job.status|capfirst }}"
                >
              </td>
              <td><a href="{{ job.get_absolute_url }}">{{ job.identifier }}</a></td>
              <td>
                <time datetime="{{ job.created_at.isoformat }}">
                  {{ job.created_at }}
                </time>
              </td>
              <td>{{ job.runtime }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>

      </div>

    </div>
  </div>
</div>
{% endblock staff_content %}
