{% extends "base.html" %}

{% load duration_tools %}
{% load humanize %}

{% block metatitle %}Status | OpenSAFELY Jobs{% endblock metatitle %}

{% block breadcrumbs %}
  {% #breadcrumbs %}
    {% url "home" as home_url %}
    {% breadcrumb title="Home" url=home_url %}
    {% breadcrumb title="Status" active=True %}
  {% /breadcrumbs %}
{% endblock breadcrumbs %}

{% block above_content %}{% endblock %}

{% block content %}
  <div class="grid gap-y-12">
    <div class="prose">
      <h1>OpenSAFELY Status</h1>
      <p>This page provides information about the status of the OpenSAFELY platform.</p>
      <p>OpenSAFELY consists of {% link href="https://docs.opensafely.org/technical-architecture/" text="several interconnected systems, websites, and databases" new_tab="true" %} that work together to provide a secure, transparent, open-source software platform for analysis of electronic health records data.</p>

      <h2>Systems status</h2>
      <p>The real-time status of the individual components that make up the OpenSAFELY platform can be viewed on the {% link href="https://status.opensafely.org/" text="OpenSAFELY status website &nearr;&#xFE0E;" append_after="." new_tab="true" %}</p>

      <h2>Backend status</h2>
      <p>A 'backend' is a secure, live data environment, managed by a provider of electronic health records data.</p>
      <p>The status of each backend which can run jobs for OpenSAFELY researchers can be viewed below.</p>
    </div>

    <div class="grid gap-8 md:grid-cols-2 xl:grid-cols-3">
      {% for backend in backends %}
        <div>
          {% fragment as my_fragment %}
            {% if backend.show_warning %}
              {% pill variant="warning" text="Missing" %}
            {% endif %}
          {% endfragment %}

          {% #card title=backend.name custom_button=my_fragment %}
            <div>
              {% if backend.name == "TPP" and tpp_maintenance_banner is True %}
                {% #description_item title="Maintenance mode" stacked=True class="!bg-bn-flamenco-200 text-bn-flamenco-900" %}
                  <p>The {{ backend.name }} database is in maintenance mode, {% link append_after="." href="#db-maintenance-mode" text="find out what this means" %}</p>
                {% /description_item %}
              {% endif %}
              {% #description_item title="Running jobs" stacked=True %}
                {{ backend.queue.running }}
              {% /description_item %}
              {% #description_item title="Pending jobs" stacked=True %}
                {{ backend.queue.pending }}
              {% /description_item %}
              {% #description_item title="Last contact with "|add:backend.name|add:" backend" stacked=True %}
                <time
                  class="
                         text-slate-900 group relative cursor-pointer
                         {% if not backend.last_seen %}text-bn-ribbon-900{% endif %}
                        "
                  datetime="{{ backend.last_seen|date:"Y-m-d H:i:sO" }}">
                  {{ backend.last_seen|naturaltime }}
                  {% if backend.last_seen %}
                    {% tooltip class="font-mono" position="-bottom-4" content=backend.last_seen|date:"d M Y H:i:s e" %}
                  {% endif %}
                </time>
              {% /description_item %}
              {% #description_item title="Job requests not yet processed by "|add:backend.name|add:" backend" stacked=True %}
                {{ backend.queue.unacked|floatformat:"-3g" }}
              {% /description_item %}
              {% #description_item title="Total job requests received by "|add:backend.name|add:" backend" stacked=True %}
                {{ backend.queue.acked|floatformat:"-3g" }}
              {% /description_item %}
            </div>
            {% #card_footer no_container class="border-t border-t-slate-200" %}
              <p class="text-sm font-medium text-slate-600">
                {{ backend.name }} backend is missing if OpenSAFELY Jobs does
                not receive a response for {{ backend.alert_timeout|duration }}.
              </p>
            {% /card_footer %}
          {% /card %}
        </div>
      {% endfor %}
    </div>

    <div class="prose">
      <h2 id="db-maintenance-mode">Database maintenance mode</h2>
      <p>Backend databases undergo regular routine maintenance.</p>

      <h3>What this means for you</h3>
      <ul>
        <li>Database jobs will be paused during maintenance.</li>
        <li>Any database jobs that were running will be stopped and queued to restart once maintenance mode is finished.</li>
        <li>Non-database jobs will be unaffected, unless they are dependent on a database job that's been paused due to maintenance mode, in which case they may take longer than normal to run.</li>
      </ul>
    </div>
  </div>
{% endblock %}
